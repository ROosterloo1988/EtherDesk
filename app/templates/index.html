<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --text-muted: #94a3b8; --primary: #3b82f6; --success: #10b981; --wa: #25D366; --sms: #4285F4; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; height: 100vh; box-sizing: border-box; overflow: hidden; }
        
        /* Layout Grid */
        .container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 100%; }
        
        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); }
        h2 { margin: 0 0 10px 0; font-size: 1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .slogan { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px; display: block; }
        
        /* Stats */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        .stat-val { font-weight: bold; }

        /* Knoppen */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; margin-bottom: 10px; transition: opacity 0.2s; text-align: left; display: flex; align-items: center; justify-content: space-between; }
        .btn:hover { opacity: 0.9; }
        .btn-wa { background: var(--wa); }
        .btn-sms { background: var(--sms); }
        .btn-update { background: #f59e0b; display: none; text-align: center; justify-content: center; }

        /* Berichtencentrum */
        .main-content { background: var(--card); border-radius: 12px; border: 1px solid #334155; display: flex; flex-direction: column; overflow: hidden; }
        .header { padding: 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .msg-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        
        .msg-item { padding: 15px 20px; border-bottom: 1px solid #334155; animation: fadeIn 0.3s ease; }
        .msg-item.unread { background: rgba(59, 130, 246, 0.1); border-left: 4px solid var(--primary); }
        .msg-meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .msg-body { font-size: 1rem; line-height: 1.4; white-space: pre-wrap; }
        .source-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .bg-WhatsApp { background: var(--wa); color: #000; }
        .bg-SMS { background: var(--sms); color: #fff; }
        .bg-Matrix { background: #fff; color: #000; }

        /* QR Modal */
        #qrModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 30px; border-radius: 12px; text-align: center; max-width: 400px; width: 100%; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; color: #fff; cursor: pointer; font-size: 1.5rem; }
        #qrImage { max-width: 250px; border: 5px solid white; display: none; margin: 20px auto; }
        #qrStatus { color: var(--text-muted); font-family: monospace; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="card">
            <h1>{{ studio_name }}</h1>
            <span class="slogan">{{ slogan }}</span>
            <hr style="border-color: #334155; margin: 15px 0;">
            
            <div class="stat-row"><span>Vandaag:</span> <span class="stat-val" id="stat-total">-</span></div>
            <div class="stat-row"><span>Ongelezen:</span> <span class="stat-val" id="stat-unread">-</span></div>
        </div>

        <div class="card">
            <h2>Verbindingen</h2>
            <button class="btn btn-wa" onclick="openQrModal('whatsapp')">
                <span>WhatsApp Koppelen</span> <span>ðŸ”—</span>
            </button>
            <button class="btn btn-sms" onclick="openQrModal('gmessages')">
                <span>SMS Koppelen</span> <span>ðŸ’¬</span>
            </button>
            <p style="font-size:0.75rem; color:#64748b; margin-top:10px;">
                Klik om een verbinding te starten of te herstellen.
            </p>
        </div>

        <button id="updateBtn" class="btn btn-update" onclick="doUpdate()">ðŸš€ Update Beschikbaar!</button>
    </div>

    <div class="main-content">
        <div class="header">
            <h2 style="color:white; margin:0;">Inkomende Berichten</h2>
            <div style="font-size:0.8rem; color:#64748b;">Live feed</div>
        </div>
        <ul class="msg-list" id="msgList">
            <li style="padding:20px; text-align:center; color:#64748b;">Laden...</li>
        </ul>
    </div>
</div>

<div id="qrModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeQrModal()">&times;</span>
        <h2 id="modalTitle">Koppelen</h2>
        <p style="font-size:0.9rem; color:#94a3b8;">Open de app op je telefoon en scan de code.</p>
        
        <div id="qrStatus">Verbinding maken met bridge...</div>
        <img id="qrImage" src="" alt="QR Code">
    </div>
</div>

<script>
    // --- FUNCTIES VOOR BERICHTEN ---
    function loadStats() {
        fetch('/api/stats').then(r => r.json()).then(d => {
            document.getElementById('stat-total').
